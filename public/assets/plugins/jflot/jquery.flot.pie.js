(function(e){function t(t){function o(e,t){t.series.pie.show&&(t.grid.show=!1,"auto"==t.series.pie.label.show&&(t.series.pie.label.show=t.legend.show?!1:!0),"auto"==t.series.pie.radius&&(t.series.pie.radius=t.series.pie.label.show?.75:1),t.series.pie.tilt>1&&(t.series.pie.tilt=1),0>t.series.pie.tilt&&(t.series.pie.tilt=0),e.hooks.processDatapoints.push(s),e.hooks.drawOverlay.push(E),e.hooks.draw.push(d))}function a(e,t){var n=e.getOptions();n.series.pie.show&&n.grid.hoverable&&t.unbind("mousemove").mousemove(g),n.series.pie.show&&n.grid.clickable&&t.unbind("click").click(m)}function r(e){for(var t=0;e.length>t;++t){var n=parseFloat(e[t].data[0][1]);n&&(O+=n)}}function s(t){A||(A=!0,D=t.getCanvas(),_=e(D).parent(),n=t.getOptions(),t.setData(u(t.getData())))}function l(){K=_.children().filter(".legend").children().width(),I=Math.min(D.width,D.height/n.series.pie.tilt)/2,k=D.height/2+n.series.pie.offset.top,w=D.width/2,"auto"==n.series.pie.offset.left?n.legend.position.match("w")?w+=K/2:w-=K/2:w+=n.series.pie.offset.left,I>w?w=I:w>D.width-I&&(w=D.width-I)}function c(e){for(var t=0;e.length>t;++t)"number"==typeof e[t].data?e[t].data=[[1,e[t].data]]:("undefined"==typeof e[t].data||"undefined"==typeof e[t].data[0])&&("undefined"!=typeof e[t].data&&"undefined"!=typeof e[t].data.label&&(e[t].label=e[t].data.label),e[t].data=[[1,0]]);return e}function u(e){e=c(e),r(e);for(var t=0,i=0,o=n.series.pie.combine.color,a=[],s=0;e.length>s;++s)e[s].data[0][1]=parseFloat(e[s].data[0][1]),e[s].data[0][1]||(e[s].data[0][1]=0),e[s].data[0][1]/O<=n.series.pie.combine.threshold?(t+=e[s].data[0][1],i++,o||(o=e[s].color)):a.push({data:[[1,e[s].data[0][1]]],color:e[s].color,label:e[s].label,angle:e[s].data[0][1]*2*Math.PI/O,percent:100*(e[s].data[0][1]/O)});return i>0&&a.push({data:[[1,t]],color:o,label:n.series.pie.combine.label,angle:t*2*Math.PI/O,percent:100*(t/O)}),a}function d(t,i){function o(){ctx.clearRect(0,0,D.width,D.height),_.children().filter(".pieLabel, .pieLabelBackground").remove()}function a(){var e=5,t=15,i=10,o=.02;if(n.series.pie.radius>1)var a=n.series.pie.radius;else var a=I*n.series.pie.radius;if(!(a>=D.width/2-e||a*n.series.pie.tilt>=D.height/2-t||i>=a)){ctx.save(),ctx.translate(e,t),ctx.globalAlpha=o,ctx.fillStyle="#000",ctx.translate(w,k),ctx.scale(1,n.series.pie.tilt);for(var r=1;i>=r;r++)ctx.beginPath(),ctx.arc(0,0,a,0,2*Math.PI,!1),ctx.fill(),a-=r;ctx.restore()}}function r(){function t(t,n,i){0>=t||(i?ctx.fillStyle=n:(ctx.strokeStyle=n,ctx.lineJoin="round"),ctx.beginPath(),Math.abs(t-2*Math.PI)>1e-9?ctx.moveTo(0,0):e.browser.msie&&(t-=1e-4),ctx.arc(0,0,o,a,a+t,!1),ctx.closePath(),a+=t,i?ctx.fill():ctx.stroke())}function i(){function t(t,i,a){if(0!=t.data[0][1]){var r,s=n.legend.labelFormatter,l=n.series.pie.label.formatter;r=s?s(t.label,t):t.label,l&&(r=l(r,t));var c=(i+t.angle+i)/2,u=w+Math.round(Math.cos(c)*o),d=k+Math.round(Math.sin(c)*o)*n.series.pie.tilt,h='<span class="pieLabel" id="pieLabel'+a+'" style="position:absolute;top:'+d+"px;left:"+u+'px;">'+r+"</span>";_.append(h);var p=_.children("#pieLabel"+a),f=d-p.height()/2,g=u-p.width()/2;if(p.css("top",f),p.css("left",g),(0-f>0||0-g>0||0>D.height-(f+p.height())||0>D.width-(g+p.width()))&&(S=!0),0!=n.series.pie.label.background.opacity){var m=n.series.pie.label.background.color;null==m&&(m=t.color);var v="top:"+f+"px;left:"+g+"px;";e('<div class="pieLabelBackground" style="position:absolute;width:'+p.width()+"px;height:"+p.height()+"px;"+v+"background-color:"+m+';"> </div>').insertBefore(p).css("opacity",n.series.pie.label.background.opacity)}}}var i=startAngle;if(n.series.pie.label.radius>1)var o=n.series.pie.label.radius;else var o=I*n.series.pie.label.radius;for(var a=0;s.length>a;++a)s[a].percent>=100*n.series.pie.label.threshold&&t(s[a],i,a),i+=s[a].angle}if(startAngle=Math.PI*n.series.pie.startAngle,n.series.pie.radius>1)var o=n.series.pie.radius;else var o=I*n.series.pie.radius;ctx.save(),ctx.translate(w,k),ctx.scale(1,n.series.pie.tilt),ctx.save();for(var a=startAngle,r=0;s.length>r;++r)s[r].startAngle=a,t(s[r].angle,s[r].color,!0);ctx.restore(),ctx.save(),ctx.lineWidth=n.series.pie.stroke.width,a=startAngle;for(var r=0;s.length>r;++r)t(s[r].angle,n.series.pie.stroke.color,!1);ctx.restore(),h(ctx),n.series.pie.label.show&&i(),ctx.restore()}if(_){ctx=i,l();for(var s=t.getData(),c=0;S&&R>c;)S=!1,c>0&&(I*=N),c+=1,o(),.8>=n.series.pie.tilt&&a(),r();c>=R&&(o(),_.prepend('<div class="error">Could not draw pie with labels contained inside canvas</div>')),t.setSeries&&t.insertLegend&&(t.setSeries(s),t.insertLegend())}}function h(e){n.series.pie.innerRadius>0&&(e.save(),innerRadius=n.series.pie.innerRadius>1?n.series.pie.innerRadius:I*n.series.pie.innerRadius,e.globalCompositeOperation="destination-out",e.beginPath(),e.fillStyle=n.series.pie.stroke.color,e.arc(0,0,innerRadius,0,2*Math.PI,!1),e.fill(),e.closePath(),e.restore(),e.save(),e.beginPath(),e.strokeStyle=n.series.pie.stroke.color,e.arc(0,0,innerRadius,0,2*Math.PI,!1),e.stroke(),e.closePath(),e.restore())}function p(e,t){for(var n=!1,i=-1,o=e.length,a=o-1;o>++i;a=i)(e[i][1]<=t[1]&&t[1]<e[a][1]||e[a][1]<=t[1]&&t[1]<e[i][1])&&t[0]<(e[a][0]-e[i][0])*(t[1]-e[i][1])/(e[a][1]-e[i][1])+e[i][0]&&(n=!n);return n}function f(e,n){for(var i=t.getData(),o=t.getOptions(),a=o.series.pie.radius>1?o.series.pie.radius:I*o.series.pie.radius,r=0;i.length>r;++r){var s=i[r];if(s.pie.show){if(ctx.save(),ctx.beginPath(),ctx.moveTo(0,0),ctx.arc(0,0,a,s.startAngle,s.startAngle+s.angle,!1),ctx.closePath(),x=e-w,y=n-k,ctx.isPointInPath){if(ctx.isPointInPath(e-w,n-k))return ctx.restore(),{datapoint:[s.percent,s.data],dataIndex:0,series:s,seriesIndex:r}}else if(p1X=a*Math.cos(s.startAngle),p1Y=a*Math.sin(s.startAngle),p2X=a*Math.cos(s.startAngle+s.angle/4),p2Y=a*Math.sin(s.startAngle+s.angle/4),p3X=a*Math.cos(s.startAngle+s.angle/2),p3Y=a*Math.sin(s.startAngle+s.angle/2),p4X=a*Math.cos(s.startAngle+s.angle/1.5),p4Y=a*Math.sin(s.startAngle+s.angle/1.5),p5X=a*Math.cos(s.startAngle+s.angle),p5Y=a*Math.sin(s.startAngle+s.angle),arrPoly=[[0,0],[p1X,p1Y],[p2X,p2Y],[p3X,p3Y],[p4X,p4Y],[p5X,p5Y]],arrPoint=[x,y],p(arrPoly,arrPoint))return ctx.restore(),{datapoint:[s.percent,s.data],dataIndex:0,series:s,seriesIndex:r};ctx.restore()}}return null}function g(e){v("plothover",e)}function m(e){v("plotclick",e)}function v(e,i){var o=t.offset(),a=parseInt(i.pageX-o.left),r=parseInt(i.pageY-o.top),s=f(a,r);if(n.grid.autoHighlight)for(var l=0;P.length>l;++l){var c=P[l];c.auto!=e||s&&c.series==s.series||C(c.series)}s&&b(s.series,e);var u={pageX:i.pageX,pageY:i.pageY};_.trigger(e,[u,s])}function b(e,n){"number"==typeof e&&(e=series[e]);var i=T(e);-1==i?(P.push({series:e,auto:n}),t.triggerRedrawOverlay()):n||(P[i].auto=!1)}function C(e){null==e&&(P=[],t.triggerRedrawOverlay()),"number"==typeof e&&(e=series[e]);var n=T(e);-1!=n&&(P.splice(n,1),t.triggerRedrawOverlay())}function T(e){for(var t=0;P.length>t;++t){var n=P[t];if(n.series==e)return t}return-1}function E(e,t){function n(e){0>e.angle||(t.fillStyle="rgba(255, 255, 255, "+o.series.pie.highlight.opacity+")",t.beginPath(),Math.abs(e.angle-2*Math.PI)>1e-9&&t.moveTo(0,0),t.arc(0,0,a,e.startAngle,e.startAngle+e.angle,!1),t.closePath(),t.fill())}var o=e.getOptions(),a=o.series.pie.radius>1?o.series.pie.radius:I*o.series.pie.radius;for(t.save(),t.translate(w,k),t.scale(1,o.series.pie.tilt),i=0;P.length>i;++i)n(P[i].series);h(t),t.restore()}var D=null,_=null,I=null,w=null,k=null,O=0,S=!0,R=10,N=.95,K=0,A=!1,P=[];t.hooks.processOptions.push(o),t.hooks.bindEvents.push(a)}var n={series:{pie:{show:!1,radius:"auto",innerRadius:0,startAngle:1.5,tilt:1,offset:{top:0,left:"auto"},stroke:{color:"#FFF",width:1},label:{show:"auto",formatter:function(e,t){return'<div style="font-size:x-small;text-align:center;padding:2px;color:'+t.color+';">'+e+"<br/>"+Math.round(t.percent)+"%</div>"},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:-1,color:null,label:"Other"},highlight:{opacity:.5}}}};e.plot.plugins.push({init:t,options:n,name:"pie",version:"1.0"})})(jQuery);
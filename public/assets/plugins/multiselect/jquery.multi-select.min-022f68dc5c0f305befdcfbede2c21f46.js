/*
* MultiSelect v0.8
* Copyright (c) 2012 Louis Cuny
*
* This program is free software. It comes without any warranty, to
* the extent permitted by applicable law. You can redistribute it
* and/or modify it under the terms of the Do What The Fuck You Want
* To Public License, Version 2, as published by Sam Hocevar. See
* http://sam.zoy.org/wtfpl/COPYING for more details.
*/
(function(e){var t={init:function(t){this.settings={disabledClass:"disabled",selectCallbackOnInit:!1,keepOrder:!1,dblClick:!1},t&&(this.settings=e.extend(this.settings,t));var i=this;return i.css("position","absolute").css("left","-9999px"),i.each(function(){var t=e(this);if(0==t.next(".ms-container").length){t.attr("id",t.attr("id")?t.attr("id"):"ms-"+Math.ceil(1e3*Math.random()));var n=e('<div id="ms-'+t.attr("id")+'" class="ms-container"></div>'),o=e('<div class="ms-selectable"></div>'),s=e('<div class="ms-selection"></div>'),a=e('<ul class="ms-list"></ul>'),r=e('<ul class="ms-list"></ul>');t.data("settings",i.settings);var l=null,c=null,u=0,h=0;t.find("optgroup,option").each(function(){if(e(this).is("optgroup"))l=e(this).attr("label"),c="ms-"+t.attr("id")+"-optgroup-"+u,a.append(e('<li class="ms-optgroup-container" id="'+c+'"><ul class="ms-optgroup"><li class="ms-optgroup-label">'+l+"</li></ul></li>")),u++;else{var n=e(this).attr("class")?" "+e(this).attr("class"):"",o=e('<li class="ms-elem-selectable'+n+'" ms-value="'+e(this).val()+'">'+e(this).text()+"</li>");e(this).attr("title")&&o.attr("title",e(this).attr("title")),(e(this).attr("disabled")||t.attr("disabled"))&&(o.attr("disabled","disabled"),o.addClass(i.settings.disabledClass)),i.settings.dblClick?o.dblclick(function(){t.multiSelect("select",e(this).attr("ms-value"))}):o.click(function(){t.multiSelect("select",e(this).attr("ms-value"))});var s=c?a.children("#"+c).find("ul").first():a;s.append(o)}}),i.settings.selectableHeader&&o.append(i.settings.selectableHeader),o.append(a),i.settings.selectedHeader&&s.append(i.settings.selectedHeader),s.append(r),n.append(o),n.append(s),t.after(n),t.find("option:selected").each(function(){t.multiSelect("select",e(this).val(),"init")}),e(".ms-elem-selectable",a).on("mouseenter",function(){e("li",n).removeClass("ms-hover"),e(this).addClass("ms-hover")}).on("mouseout",function(){e("li",n).removeClass("ms-hover")}),a.on("focusin",function(){e(this).addClass("ms-focus"),r.focusout()}).on("focusout",function(){e(this).removeClass("ms-focus"),e("li",n).removeClass("ms-hover")}),r.on("focusin",function(){e(this).addClass("ms-focus")}).on("focusout",function(){e(this).removeClass("ms-focus"),e("li",n).removeClass("ms-hover")}),t.on("focusin",function(){a.focus()}).on("focusout",function(){a.removeClass("ms-focus"),r.removeClass("ms-focus")}),t.onKeyDown=function(i,o){var s=e("."+o+" li:visible:not(.ms-optgroup-label, .ms-optgroup-container)",n),l=s.length,c=e("."+o+" li.ms-hover",n),u=e("."+o+" li:visible:not(.ms-optgroup-label, .ms-optgroup-container)",n).index(c),d=s.first().outerHeight(),p=Math.ceil(n.outerHeight()/d),f=Math.ceil(p/4);if(s.removeClass("ms-hover"),32==i.keyCode){var g="ms-selectable"==o?"select":"deselect";t.multiSelect(g,c.first().attr("ms-value"))}else if(40==i.keyCode){var m=u+1!=l?u+1:0,v=s.eq(m);v.addClass("ms-hover"),m>f?h+=d:0==m&&(h=0),e("."+o+" ul",n).scrollTop(h)}else if(38==i.keyCode){var b=u-1>=0?u-1:l-1,y=s.eq(b);s.removeClass("ms-hover"),y.addClass("ms-hover"),f>l-b+1?h=d*(l-f):h-=d,e("."+o+" ul",n).scrollTop(h)}else(37==i.keyCode||39==i.keyCode)&&(a.hasClass("ms-focus")?(a.focusout(),r.focusin()):(a.focusin(),r.focusout()))},t.on("keydown",function(e){if(t.is(":focus")){var i=a.hasClass("ms-focus")?"ms-selectable":"ms-selection";t.onKeyDown(e,i)}})}})},refresh:function(){e("#ms-"+e(this).attr("id")).remove(),e(this).multiSelect("init",e(this).data("settings"))},select:function(t,n){var o=this,s=o.find('option[value="'+t+'"]'),a=s.text(),r=s.attr("class"),l=s.attr("title"),c=e('<li class="ms-elem-selected'+(r?" "+r:"")+'" ms-value="'+t+'">'+a+"</li>"),u=e("#ms-"+o.attr("id")+" .ms-selectable ul"),h=e("#ms-"+o.attr("id")+" .ms-selection ul"),d=u.children('li[ms-value="'+t+'"]'),p=null;if("init"==n?p=!d.hasClass(o.data("settings").disabledClass)&&s.prop("selected"):(p=!d.hasClass(o.data("settings").disabledClass),o.focus()),p&&0==h.children('li[ms-value="'+t+'"]').length){var f=d.parent(".ms-optgroup");f.length>0&&1==f.children(".ms-elem-selectable:not(:hidden)").length&&f.children(".ms-optgroup-label").hide(),d.addClass("ms-selected"),d.hide(),s.prop("selected",!0),l&&c.attr("title",l),d.hasClass(o.data("settings").disabledClass)?c.addClass(o.data("settings").disabledClass):o.data("settings").dblClick?c.dblclick(function(){o.multiSelect("deselect",e(this).attr("ms-value"))}):c.click(function(){o.multiSelect("deselect",e(this).attr("ms-value"))});var g=h.children(".ms-elem-selected");if("init"!=n&&o.data("settings").keepOrder&&g.length>0){var m=function(e){return elems=u.children(".ms-elem-selectable"),elems.index(elems.closest('[ms-value="'+e+'"]'))},v=m(c.attr("ms-value"));if(0==v)h.prepend(c);else for(i=v-1;i>=0;i--){if(g[i]&&v>m(e(g[i]).attr("ms-value"))){e(g[i]).after(c);break}0==i&&e(g[i]).before(c)}}else h.append(c);c.on("mouseenter",function(){e("li",h).removeClass("ms-hover"),e(this).addClass("ms-hover")}).on("mouseout",function(){e("li",h).removeClass("ms-hover")}),"select_all"==n&&f.children(".ms-elem-selectable").length>0&&f.children(".ms-optgroup-label").hide(),("init"!=n||o.data("settings").selectCallbackOnInit)&&(o.trigger("change"),h.trigger("change"),u.trigger("change"),"function"!=typeof o.data("settings").afterSelect||"init"==n&&!o.data("settings").selectCallbackOnInit||o.data("settings").afterSelect.call(this,t,a))}},deselect:function(t){var i=this,n=e("#ms-"+i.attr("id")+" .ms-selection ul"),o=i.find('option[value="'+t+'"]'),s=n.children('li[ms-value="'+t+'"]');if(s){n.focusin();var a=e("#ms-"+i.attr("id")+" .ms-selectable ul"),n=e("#ms-"+i.attr("id")+" .ms-selection ul"),r=a.children('li[ms-value="'+t+'"]'),s=n.children('li[ms-value="'+t+'"]'),l=r.parent(".ms-optgroup");l.length>0&&(l.children(".ms-optgroup-label").addClass("ms-collapse").show(),l.children(".ms-elem-selectable:not(.ms-selected)").show()),o.prop("selected",!1),r.show(),r.removeClass("ms-selected"),s.remove(),n.trigger("change"),a.trigger("change"),i.trigger("change"),"function"==typeof i.data("settings").afterDeselect&&i.data("settings").afterDeselect.call(this,t,s.text())}},select_all:function(t){var i=this,n=e("#ms-"+i.attr("id")+" .ms-selectable ul");i.find("option:not(:selected)").each(function(){var o=e(this).val();if(t){var s=n.children('li[ms-value="'+o+'"]');s.filter(":visible").length>0&&i.multiSelect("select",o,"select_all")}else i.multiSelect("select",o,"select_all")})},deselect_all:function(){var t=this;e("#ms-"+t.attr("id")+" .ms-selection ul"),t.find("option:selected").each(function(){t.multiSelect("deselect",e(this).val(),"deselect_all")})}};e.fn.multiSelect=function(e){return t[e]?t[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?(console.log&&console.log("Method "+e+" does not exist on jquery.multiSelect"),!1):t.init.apply(this,arguments)}})(jQuery);